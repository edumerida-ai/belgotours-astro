---
const STRAPI_URL =
  import.meta.env.PUBLIC_STRAPI_URL || "https://api.belgotours.com/api";

interface Props {
  tourId: number | string;
  idioma: string;
}

const { tourId, idioma } = Astro.props;

/* ----------------------------------------
   üåç Idiomas v√°lidos
----------------------------------------- */
type Lang = "es" | "en" | "it" | "fr" | "pt";

const VALID_LANGS: Lang[] = ["es", "en", "it", "fr", "pt"];

const safeLang: Lang = VALID_LANGS.includes(idioma as Lang)
  ? (idioma as Lang)
  : "es";

/* ----------------------------------------
   Textos multilenguaje
----------------------------------------- */
const TEXTS = {
  es: {
    title: "Opiniones de viajeros",
    verified: "Viajero verificado",
    emptyComment: "El viajero dej√≥ una valoraci√≥n sin comentario p√∫blico.",
    noReviews: "A√∫n no hay rese√±as disponibles para este tour en este idioma.",
  },
  en: {
    title: "Traveler reviews",
    verified: "Verified traveler",
    emptyComment: "The traveler left a rating without a public comment.",
    noReviews: "No reviews available for this tour in this language yet.",
  },
  it: {
    title: "Recensioni dei viaggiatori",
    verified: "Viaggiatore verificato",
    emptyComment: "Il viaggiatore ha lasciato una valutazione senza commento pubblico.",
    noReviews: "Non ci sono recensioni disponibili per questo tour in questa lingua.",
  },
  fr: {
    title: "Avis des voyageurs",
    verified: "Voyageur v√©rifi√©",
    emptyComment: "Le voyageur a laiss√© une note sans commentaire public.",
    noReviews: "Aucun avis disponible pour ce tour dans cette langue.",
  },
  pt: {
    title: "Avalia√ß√µes de viajantes",
    verified: "Viajante verificado",
    emptyComment: "O viajante deixou apenas uma avalia√ß√£o sem coment√°rio p√∫blico.",
    noReviews: "Ainda n√£o h√° avalia√ß√µes para este tour neste idioma.",
  },
};

const t = TEXTS[safeLang] || TEXTS.es;

/* ----------------------------------------
   Construcci√≥n query Strapi
----------------------------------------- */
const params = new URLSearchParams();

if (tourId) {
  params.set("filters[tour][id][$eq]", String(tourId));
}

params.set("filters[idioma][$eq]", safeLang);
params.set("filters[estado][$eq]", "aprobada");
params.set("filters[visible_web][$eq]", "true");
params.append("sort[0]", "createdAt:desc");
params.set("pagination[limit]", "5");

const url = `${STRAPI_URL}/reviews?${params.toString()}`;

let rese√±as: any[] = [];

try {
  const response = await fetch(url);
  if (response.ok) {
    const json = await response.json();
    rese√±as = json?.data ?? [];
  } else {
    console.error("‚ùå Error al obtener rese√±as:", response.status);
  }
} catch (err) {
  console.error("‚ùå Error de red al obtener rese√±as:", err);
}
---

<div class="reviews-section py-8">
  <h2 class="text-2xl font-bold mb-6">
    {t.title}
  </h2>

  {rese√±as.length > 0 ? (
    <ul class="space-y-6">
      {rese√±as.map((r) => {
        const attrs = r.attributes || {};
        const rating = Number(attrs.rating_general ?? 0);
        const comentario = attrs.comentario_publico ?? "";
        const nombre = attrs.cliente_nombre ?? t.verified;
        const fecha = attrs.fecha_tour || attrs.createdAt;

        return (
          <li class="border border-gray-200 rounded-2xl p-5 bg-white shadow-sm">

            <div class="flex items-center justify-between mb-3">

              <div class="flex items-center gap-2">
                <span class="text-yellow-500 text-base">
                  {"‚òÖ".repeat(rating)}
                </span>
                <span class="text-sm text-gray-600">
                  ({rating}/5)
                </span>
              </div>

              {fecha && (
                <span class="text-sm text-gray-500">
                  {new Date(fecha).toLocaleDateString(
                    safeLang === "en"
                      ? "en-US"
                      : safeLang === "it"
                      ? "it-IT"
                      : safeLang === "fr"
                      ? "fr-FR"
                      : safeLang === "pt"
                      ? "pt-PT"
                      : "es-ES"
                  )}
                </span>
              )}
            </div>

            <p class="text-sm font-semibold text-gray-900 mb-1">
              {nombre}
            </p>

            <p class="text-gray-800 leading-relaxed">
              {comentario || t.emptyComment}
            </p>

          </li>
        );
      })}
    </ul>
  ) : (
    <p class="text-gray-600 italic">
      {t.noReviews}
    </p>
  )}
</div>