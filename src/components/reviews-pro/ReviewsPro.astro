---
import { REVIEWS_I18N } from "./reviews.i18n.js";

const STRAPI_API =
  import.meta.env.PUBLIC_STRAPI_URL || "https://api.belgotours.com/api";

interface Props {
  tourSlug: string;
  lang: string;
  limit?: number;
  offset?: number;
}

const { tourSlug, lang, limit = 8, offset = 0 } = Astro.props;

/* --------------------------------------------------
   ðŸŒ Idiomas vÃ¡lidos para TOURS
-------------------------------------------------- */
const VALID_TOUR_LANGS = ["es", "en", "it", "fr"];

/* Si llega pt u otro idioma â†’ fallback elegante */
const safeLang = VALID_TOUR_LANGS.includes(lang) ? lang : "es";

const t = REVIEWS_I18N[safeLang] || REVIEWS_I18N.es;

/* --------------------------------------------------
   Fetch a Strapi
-------------------------------------------------- */
const params = new URLSearchParams();
params.set("tour", tourSlug);
params.set("lang", safeLang);
params.set("limit", String(limit));
params.set("offset", String(offset));

const url = `${STRAPI_API.replace(/\/$/, "")}/public/reviews-pro?${params.toString()}`;

let data = null;

try {
  const res = await fetch(url, {
    headers: { Accept: "application/json" },
  });

  if (res.ok) {
    data = await res.json();
  } else {
    console.error("âŒ Error HTTP reviews-pro:", res.status, await res.text());
  }
} catch (e) {
  console.error("âŒ Error loading reviews-pro", e);
}

/* --------------------------------------------------
   NormalizaciÃ³n segura
-------------------------------------------------- */
const summary = data?.summary || null;
const categories = data?.categories || null;
const reviews = data?.reviews || [];
const pagination = data?.pagination || null;

function ratingLabel(r) {
  const n = Number(r || 0);
  if (n >= 4.8) return t.labelTop;
  if (n >= 4.3) return t.labelHigh;
  if (n >= 3.6) return t.labelMid;
  if (n >= 2.8) return t.labelLow;
  return t.labelBad;
}

function pct(part, total) {
  const p = Number(part || 0);
  const tt = Number(total || 0);
  if (!tt) return 0;
  return Math.round((p / tt) * 100);
}

const totalReviews = Number(summary?.total || 0);
const avgRating = Number(summary?.rating || 0);
const label = summary?.label || ratingLabel(avgRating);

const stars = summary?.stars || { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
---

<section id="reviews-pro" class="py-16 bg-white">
  <div class="container mx-auto px-4">
    <div class="max-w-6xl mx-auto">

      {totalReviews > 0 ? (
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">

          <!-- LEFT: SUMMARY -->
          <div class="lg:col-span-5">
            <div class="bg-gray-50 rounded-2xl p-6 border border-gray-200">

              <div class="text-5xl font-extrabold text-gray-900">
                {avgRating.toFixed(1)}
              </div>

              <div class="mt-2 flex items-center gap-2">
                <span class="text-yellow-500 text-xl">
                  {"â˜…".repeat(Math.round(avgRating))}
                </span>

                <span class="text-sm font-semibold text-gray-800">
                  {label}
                </span>
              </div>

              <div class="mt-2 text-sm text-gray-600">
                {t.basedOn} <span class="font-semibold">{totalReviews}</span> {t.reviewsWord}
              </div>

              <div class="mt-6 space-y-2">
                {[5,4,3,2,1].map((s) => {
                  const count = stars?.[s] ?? 0;
                  const percent = pct(count, totalReviews);

                  return (
                    <div class="flex items-center gap-3">
                      <div class="w-8 text-sm">{s}â˜…</div>
                      <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div
                          class="h-2 bg-yellow-400"
                          style={`width:${percent}%;`}
                        />
                      </div>
                      <div class="w-10 text-right text-sm text-gray-600">
                        {percent}%
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {categories && (
              <div class="mt-6 bg-gray-50 rounded-2xl p-6 border border-gray-200">
                <div class="text-sm font-semibold text-gray-800 mb-4">
                  {t.categoriesTitle}
                </div>

                <div class="space-y-3">
                  {[
                    ["profesionalidad", t.professionalism],
                    ["diversion", t.fun],
                    ["comunicacion", t.communication],
                    ["calidad", t.quality],
                    ["ruta", t.route],
                  ].map(([key, label]) => {
                    const val = Number(categories?.[key] ?? 0);
                    const percent = Math.round((val / 5) * 100);

                    return (
                      <div>
                        <div class="flex justify-between text-sm mb-1">
                          <span>{label}</span>
                          <span class="font-semibold">{val.toFixed(1)}</span>
                        </div>

                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                          <div
                            class="h-2 bg-gray-900"
                            style={`width:${percent}%;`}
                          />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>

          <!-- RIGHT: REVIEWS -->
          <div class="lg:col-span-7">
            <div class="grid gap-6">
              {reviews.map((r) => (
                <article class="border border-gray-200 rounded-2xl p-6 shadow-sm">

                  <div class="flex justify-between items-start">
                    <div>
                      <div class="font-semibold text-gray-900">
                        {r.nombre || t.verified}
                      </div>

                      <div class="text-sm text-gray-600 mt-1">
                        {r.pais && <span>{r.pais}</span>}
                        {r.fecha && (
                          <span>
                            {" â€¢ "}
                            {new Date(r.fecha).toLocaleDateString(
                              safeLang === "en"
                                ? "en-US"
                                : safeLang === "it"
                                ? "it-IT"
                                : safeLang === "fr"
                                ? "fr-FR"
                                : "es-ES"
                            )}
                          </span>
                        )}
                      </div>
                    </div>

                    <div class="text-yellow-500">
                      {"â˜…".repeat(Number(r.rating || 0))}
                    </div>
                  </div>

                  <p class="text-gray-800 mt-4 leading-relaxed">
                    {r.comentario}
                  </p>
                </article>
              ))}
            </div>
          </div>

        </div>
      ) : (
        <p class="text-gray-600 italic">
          {t.noReviews}
        </p>
      )}

    </div>
  </div>
</section>