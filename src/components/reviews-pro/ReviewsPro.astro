---
import { REVIEWS_I18N } from "./reviews.i18n.js";

const STRAPI_API =
  import.meta.env.PUBLIC_STRAPI_URL || "https://api.belgotours.com/api"

interface Props {
  tourSlug: string;
  lang: string;
  limit?: number;
  offset?: number;
}

const { tourSlug, lang, limit = 8, offset = 0 } = Astro.props;

const t = REVIEWS_I18N[lang] || REVIEWS_I18N.es;

const params = new URLSearchParams();
params.set("tour", tourSlug);
params.set("lang", lang);
params.set("limit", String(limit));
params.set("offset", String(offset));

const url = `${STRAPI_API.replace(/\/$/, "")}/public/reviews-pro?${params.toString()}`;

let data = null;

try {
  const res = await fetch(url, {
    headers: { Accept: "application/json" },
  });

  if (res.ok) {
    data = await res.json();
  } else {
    console.error("❌ Error HTTP reviews-pro:", res.status, await res.text());
  }
} catch (e) {
  console.error("❌ Error loading reviews-pro", e);
}

const summary = data?.summary || null;
const categories = data?.categories || null;
const reviews = data?.reviews || [];
const pagination = data?.pagination || null;

function ratingLabel(r) {
  const n = Number(r || 0);
  if (n >= 4.8) return t.labelTop;
  if (n >= 4.3) return t.labelHigh;
  if (n >= 3.6) return t.labelMid;
  if (n >= 2.8) return t.labelLow;
  return t.labelBad;
}

function pct(part, total) {
  const p = Number(part || 0);
  const tt = Number(total || 0);
  if (!tt) return 0;
  return Math.round((p / tt) * 100);
}

const totalReviews = Number(summary?.total || 0);
const avgRating = Number(summary?.rating || 0);
const label = summary?.label || ratingLabel(avgRating);

const stars = summary?.stars || { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
---

<section id="reviews-pro" class="py-16 bg-white">
  <div class="container mx-auto px-4">
    <div class="max-w-6xl mx-auto">
  
      {totalReviews > 0 ? (
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
          <!-- LEFT: SUMMARY + BARS -->
          <div class="lg:col-span-5">
            <div class="bg-gray-50 rounded-2xl p-6 border border-gray-200">
              <div class="flex items-end justify-between gap-6">
                <div>
                  <div class="text-5xl font-extrabold text-gray-900">
                    {avgRating.toFixed(1)}
                  </div>
                  <div class="mt-2 flex items-center gap-2">
                    <span class="text-yellow-500 text-xl leading-none">
                     {"★".repeat(Math.round(avgRating))}
                     </span>

                    <span class="text-sm text-gray-700 font-semibold">
                      {label}
                    </span>
                  </div>
                  <div class="mt-2 text-sm text-gray-600">
                    {t.basedOn} <span class="font-semibold">{totalReviews}</span> {t.reviewsWord}
                  </div>
                </div>
              </div>

              <div class="mt-6">
                <div class="text-sm font-semibold text-gray-800 mb-3">
                  {t.starsTitle}
                </div>

                <div class="space-y-2">
                  {[5, 4, 3, 2, 1].map((s) => {
                    const count = stars?.[s] ?? 0;
                    const percent = pct(count, totalReviews);
                    return (
                      <div class="flex items-center gap-3">
                        <div class="w-10 text-sm text-gray-700 font-medium">
                          {s}★
                        </div>
                        <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                          <div
                            class="h-2 bg-yellow-400"
                            style={`width:${percent}%;`}
                          ></div>
                        </div>
                        <div class="w-12 text-right text-sm text-gray-600">
                          {percent}%
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>

            {categories && (
              <div class="mt-6 bg-gray-50 rounded-2xl p-6 border border-gray-200">
                <div class="text-sm font-semibold text-gray-800 mb-4">
                  {t.categoriesTitle}
                </div>

                <div class="space-y-3">
                  {[
                    ["profesionalidad", "Profesionalidad"],
                    ["diversion", "Diversión"],
                    ["comunicacion", "Comunicación"],
                    ["calidad", "Calidad"],
                    ["ruta", "Ruta"],
                  ].map(([key, label]) => {
                    const val = Number(categories?.[key] ?? 0);
                    const percent = Math.round((val / 5) * 100);
                    return (
                      <div>
                        <div class="flex items-center justify-between text-sm mb-1">
                          <span class="text-gray-700 font-medium">{label}</span>
                          <span class="text-gray-900 font-semibold">{val.toFixed(1)}</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                          <div
                            class="h-2 bg-gray-900"
                            style={`width:${percent}%;`}
                          ></div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>

          <!-- RIGHT: REVIEWS GRID -->
          <div class="lg:col-span-7">
            <div class="grid gap-6">
              {reviews.map((r) => (
                <article class="border border-gray-200 rounded-2xl p-6 bg-white shadow-sm">
                  <div class="flex items-start justify-between gap-4">
                    <div>
                      <div class="font-semibold text-gray-900">
                        {r.nombre || "Viajero verificado"}
                      </div>
                      <div class="text-sm text-gray-600 mt-1 flex flex-wrap gap-2">
                        {r.pais && <span>{r.pais}</span>}
                        {r.fecha && (
                          <span>
                            •{" "}
                            {new Date(r.fecha).toLocaleDateString(
                              lang === "en"
                                ? "en-US"
                                : lang === "it"
                                  ? "it-IT"
                                  : lang === "fr"
                                    ? "fr-FR"
                                    : "es-ES"
                            )}
                          </span>
                        )}
                        <span class="text-xs px-2 py-0.5 rounded-full border border-gray-200 bg-gray-50 text-gray-600">
                          {r.verificada ? t.verified : t.notVerified}
                        </span>
                      </div>
                    </div>
            <div class="text-yellow-500 text-base leading-none whitespace-nowrap">
                   {"★".repeat(Number(r.rating || 0))}
                    </div>
                 </div>

                  <p class="text-gray-800 mt-4 leading-relaxed">
                    {r.comentario || ""}
                  </p>
                </article>
              ))}
            </div>

            {pagination?.hasMore && (
              <div class="mt-8 text-center">
                <a
                  href={`#reviews-pro`}
                  class="inline-flex items-center justify-center bg-gray-900 text-white font-semibold px-6 py-3 rounded-xl hover:opacity-90 transition"
                >
                  Cargar más (próximo)
                </a>
              </div>
            )}
          </div>
        </div>
      ) : (
        <p class="text-gray-600 italic">
          {t.noReviews}
        </p>
      )}
    </div>
  </div>
</section>
