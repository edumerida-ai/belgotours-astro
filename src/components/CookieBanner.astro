---
interface Props {
  lang: string;
}

const { lang = "es" } = Astro.props;

const COOKIE_KEY = "belgotours_cookie_consent";
const ONE_YEAR_MS = 1000 * 60 * 60 * 24 * 365;

const t = {
  es: {
    text:
      "Utilizamos cookies propias y de terceros para mejorar la experiencia, analizar el tráfico y personalizar contenidos.",
    more: "Más información",
    accept: "Aceptar todo",
    reject: "Rechazar",
    settings: "Configurar",
    panelTitle: "Preferencias de cookies",
    essential: "Cookies esenciales",
    essentialDesc: "Necesarias para el funcionamiento del sitio",
    analytics: "Cookies analíticas",
    analyticsDesc: "Nos ayudan a mejorar la web",
    marketing: "Cookies de marketing",
    marketingDesc: "Contenido personalizado y publicidad",
    save: "Guardar preferencias",
    close: "Cerrar"
  },

  en: {
    text:
      "We use our own and third-party cookies to improve your experience, analyze traffic and personalize content.",
    more: "Learn more",
    accept: "Accept all",
    reject: "Reject",
    settings: "Customize",
    panelTitle: "Cookie preferences",
    essential: "Essential cookies",
    essentialDesc: "Required for site functionality",
    analytics: "Analytics cookies",
    analyticsDesc: "Help us improve the website",
    marketing: "Marketing cookies",
    marketingDesc: "Personalized content and ads",
    save: "Save preferences",
    close: "Close"
  },

  it: {
    text:
      "Utilizziamo cookie propri e di terze parti per migliorare l’esperienza, analizzare il traffico e personalizzare i contenuti.",
    more: "Maggiori informazioni",
    accept: "Accetta tutto",
    reject: "Rifiuta",
    settings: "Configura",
    panelTitle: "Preferenze cookie",
    essential: "Cookie essenziali",
    essentialDesc: "Necessari per il funzionamento del sito",
    analytics: "Cookie analitici",
    analyticsDesc: "Ci aiutano a migliorare il sito",
    marketing: "Cookie di marketing",
    marketingDesc: "Contenuti personalizzati e pubblicità",
    save: "Salva preferenze",
    close: "Chiudi"
  },

  fr: {
    text:
      "Nous utilisons des cookies propres et tiers pour améliorer l’expérience, analyser le trafic et personnaliser le contenu.",
    more: "En savoir plus",
    accept: "Tout accepter",
    reject: "Refuser",
    settings: "Configurer",
    panelTitle: "Préférences des cookies",
    essential: "Cookies essentiels",
    essentialDesc: "Nécessaires au fonctionnement du site",
    analytics: "Cookies analytiques",
    analyticsDesc: "Nous aident à améliorer le site",
    marketing: "Cookies marketing",
    marketingDesc: "Contenu personnalisé et publicité",
    save: "Enregistrer",
    close: "Fermer"
  },
};
const copy = t[lang] || t.es;
---

<div
  id="cookie-banner"
  class="fixed bottom-0 left-0 right-0 z-[9999] hidden
         bg-white border-t border-gray-200
         shadow-2xl p-6 md:p-8"
>
  <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-start md:items-center justify-between gap-6">

    <p class="text-sm md:text-base text-gray-700 leading-relaxed max-w-3xl">
      {copy.text}
      <a href={`/${lang}/cookies`} class="underline font-medium ml-1">
        {copy.more}
      </a>
    </p>

    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">

      <button
        id="reject-cookies"
        type="button"
        class="border border-gray-300
               text-gray-800 font-medium
               px-5 py-3 rounded-xl
               hover:bg-gray-100 transition"
      >
        {copy.reject}
      </button>

      <button
        id="settings-cookies"
        type="button"
        class="text-gray-800 underline font-medium
               px-4 py-3 transition"
      >
        {copy.settings}
      </button>

      <button
        id="accept-cookies"
        type="button"
        class="bg-black text-white font-semibold
               px-6 py-3 rounded-xl
               hover:bg-gray-900 transition"
      >
        {copy.accept}
      </button>

    </div>
  </div>
</div>

<div
  id="cookie-settings-panel"
  class="fixed inset-0 bg-black/40 z-[10000] hidden items-center justify-center p-4"
>
  <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 space-y-5">

    <h3 class="text-lg font-semibold text-gray-900">
      {copy.panelTitle}
    </h3>

    <div class="space-y-4 text-sm text-gray-700">

      <!-- Essential -->
      <div class="flex justify-between items-center">
        <div>
          <p class="font-medium">{copy.essential}</p>
          <p class="text-xs text-gray-500">{copy.essentialDesc}</p>
        </div>
        <input type="checkbox" checked disabled class="accent-black w-5 h-5" />
      </div>

      <!-- Analytics -->
      <div class="flex justify-between items-center">
        <div>
          <p class="font-medium">{copy.analytics}</p>
          <p class="text-xs text-gray-500">{copy.analyticsDesc}</p>
        </div>
        <input id="analytics-toggle" type="checkbox" class="accent-black w-5 h-5" />
      </div>

      <!-- Marketing -->
      <div class="flex justify-between items-center">
        <div>
          <p class="font-medium">{copy.marketing}</p>
          <p class="text-xs text-gray-500">{copy.marketingDesc}</p>
        </div>
        <input id="marketing-toggle" type="checkbox" class="accent-black w-5 h-5" />
      </div>

    </div>

    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
      <button
        id="close-cookie-settings"
        class="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-100"
      >
        {copy.close}
      </button>

      <button
        id="save-cookie-settings"
        class="px-5 py-2 text-sm bg-black text-white rounded-lg hover:bg-gray-900"
      >
        {copy.save}
      </button>
    </div>

  </div>
</div>

<script is:inline>
  const COOKIE_KEY = "belgotours_cookie_consent";
  const ONE_YEAR_MS = 1000 * 60 * 60 * 24 * 365;

  const banner = document.getElementById("cookie-banner");
  const acceptBtn = document.getElementById("accept-cookies");
  const rejectBtn = document.getElementById("reject-cookies");
  const settingsBtn = document.getElementById("settings-cookies");

  function getConsent() {
    try {
      const raw = localStorage.getItem(COOKIE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }
function setConsent(type, customOptions = null) {
  const expires = Date.now() + ONE_YEAR_MS;

  let data = {
    type,
    analytics: false,
    marketing: false,
    expires,
  };

  if (type === "all") {
    data.analytics = true;
    data.marketing = true;
  }

  if (type === "essential") {
    data.analytics = false;
    data.marketing = false;
  }

  if (type === "custom" && customOptions) {
    data.analytics = !!customOptions.analytics;
    data.marketing = !!customOptions.marketing;
  }

  localStorage.setItem(COOKIE_KEY, JSON.stringify(data));

  banner?.classList.add("hidden");

  // Notificar al sistema que cambió consentimiento
  window.dispatchEvent(new Event("cookieConsentUpdated"));
}

function isValidConsent(data) {
  return data?.expires && Date.now() < data.expires;
}

const consent = getConsent();

if (!isValidConsent(consent)) {
  banner?.classList.remove("hidden");
}

// =============================
// BOTONES PRINCIPALES
// =============================

acceptBtn?.addEventListener("click", () => {
  setConsent("all");
});

rejectBtn?.addEventListener("click", () => {
  setConsent("essential");
});

// =============================
// PANEL PERSONALIZADO
// =============================

const panel = document.getElementById("cookie-settings-panel");
const closePanelBtn = document.getElementById("close-cookie-settings");
const savePanelBtn = document.getElementById("save-cookie-settings");
const analyticsToggle = document.getElementById("analytics-toggle");
const marketingToggle = document.getElementById("marketing-toggle");

settingsBtn?.addEventListener("click", () => {
  panel?.classList.remove("hidden");
});

closePanelBtn?.addEventListener("click", () => {
  panel?.classList.add("hidden");
});

savePanelBtn?.addEventListener("click", () => {
  setConsent("custom", {
    analytics: analyticsToggle?.checked || false,
    marketing: marketingToggle?.checked || false,
  });

  panel?.classList.add("hidden");
});
</script>