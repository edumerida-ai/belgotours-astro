---
/**
 * BookingCalendar.astro — conectado a Strapi (SSR)
 * UI refinada BelgoTours · sin tocar lógica
 */

const API =
  import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337/api";

interface Props {
  tour?: any;
  lang?: string;
}

const { tour = {}, lang = "es" } = Astro.props;

const tourId =
  tour?.id ||
  tour?.strapiId ||
  tour?.documentId ||
  tour?.attributes?.id ||
  3;

// Textos UI
const texts =
  {
    es: {
      selectDate: "Selecciona una fecha",
      selectTime: "Selecciona un horario",
      noTimes: "No hay horarios para esta fecha",
      maxPeople: "Plazas disponibles",
    },
    en: {
      selectDate: "Select a date",
      selectTime: "Select a time",
      noTimes: "No times available for this date",
      maxPeople: "Available spots",
    },
    it: {
      selectDate: "Seleziona una data",
      selectTime: "Seleziona un orario",
      noTimes: "Nessun orario disponibile per questa data",
      maxPeople: "Posti disponibili",
    },
  }[lang];

function todayISO() {
  const d = new Date();
  return d.toISOString().split("T")[0];
}

async function getHorariosByTourId(id) {
  const params = new URLSearchParams();
  params.set("populate", "*");
  params.set("filters[tour][id][$eq]", String(id));
  params.set("filters[fecha][$gte]", todayISO());
  params.set("pagination[limit]", "100");
  params.set("sort[0]", "fecha:asc");
  params.set("sort[1]", "hora:asc");

  const res = await fetch(`${API}/horarios?${params.toString()}`);
  const json = await res.json();

  return (json?.data ?? []).map((h) => {
    const a = h.attributes ?? h;
    const max = Number(a.cupoMaximo ?? 25);
    const ocup = Number(a.cupoOcupado ?? 0);
    return {
      id: h.id,
      fecha: a.fecha,
      hora: a.hora,
      cupoDisponible: Math.max(0, max - ocup),
      cupoMaximo: max,
      cupoOcupado: ocup,
    };
  });
}

const horariosRaw = await getHorariosByTourId(tourId);
const horarios = horariosRaw.filter((h) => h.cupoDisponible > 0);
const fechasDisponibles = [...new Set(horarios.map((h) => h.fecha))];
---

<div class="calendar-2026 space-y-8" data-lang={lang}>
  <!-- Fecha -->
  <div>
    <label class="block font-semibold mb-2 text-gray-800">
      {texts.selectDate}
    </label>
    <input
      id="fechaPicker"
      type="date"
      class="w-full md:w-auto border border-gray-300 rounded-xl px-4 py-3 text-gray-800 focus:ring-2 focus:ring-yellow-400 focus:outline-none"
      value={fechasDisponibles[0] || todayISO()}
      min={fechasDisponibles[0] || todayISO()}
      max={fechasDisponibles[fechasDisponibles.length - 1] || todayISO()}
    />
  </div>

  <!-- Horarios -->
  <div>
    <label class="block font-semibold mb-3 text-gray-800">
      {texts.selectTime}
    </label>

    <div
      id="horariosContainer"
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
    ></div>
  </div>
</div>

<script type="application/json" id="horarios-data" set:html={JSON.stringify(horarios)}></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const horarios = JSON.parse(
    document.getElementById("horarios-data")?.textContent || "[]"
  );

  const fechaPicker = document.getElementById("fechaPicker");
  const contenedor = document.getElementById("horariosContainer");

  function renderHorarios(fecha) {
    contenedor.innerHTML = "";

    const delDia = horarios.filter((h) => h.fecha === fecha);

    if (!delDia.length) {
      contenedor.innerHTML =
        "<p class='text-sm text-gray-500'>No hay horarios para esta fecha</p>";
      return;
    }

    delDia.forEach((h) => {
      const btn = document.createElement("button");

      btn.className = `
        time-slot
        border border-gray-300
        rounded-2xl p-4 text-center
        bg-white
        hover:border-yellow-400 hover:bg-yellow-50
        transition
      `;

       btn.innerHTML = `
       <div class="text-lg font-semibold text-gray-900">
       ${h.hora}
       </div>
       `;


      btn.onclick = () => {
        document.querySelectorAll(".time-slot").forEach((el) => {
          el.classList.remove("border-yellow-400", "bg-yellow-100");
        });

        btn.classList.add("border-yellow-400", "bg-yellow-100");

        window.bookingState = window.bookingState || {};
        window.bookingState.selectedDate = h.fecha;
        window.bookingState.selectedTime = h.hora;
        window.bookingState.horarioId = h.id;

        window.dispatchEvent(new CustomEvent("dateSelected"));
        window.dispatchEvent(new CustomEvent("timeSelected"));
      };

      contenedor.appendChild(btn);
    });
  }

  renderHorarios(fechaPicker.value);
  fechaPicker.addEventListener("change", (e) =>
    renderHorarios(e.target.value)
  );
});
</script>


<style>
.time-slot {
  transition: transform .2s ease;
}
.time-slot:hover {
  transform: translateY(-2px);
}
.time-slot:active {
  transform: scale(0.98);
}
</style>
