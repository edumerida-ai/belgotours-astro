---
/**
 * src/components/tours/GuidesSectionTour.astro
 *
 * Bloque 7 (TOURS): muestra SOLO gu√≠as asociados a este tour (no global).
 * - NO canibaliza SEO: es un bloque contextual, no una p√°gina de gu√≠as.
 * - NO hace fetch: recibe `guias` ya populadas desde la p√°gina del tour.
 * - Robusto: soporta Strapi v4/v5 (data/attributes) y media con formatos.
 */

interface Props {
  lang: string;
  guias?: any[]; // Strapi relation array: [{ id, attributes? }] or [{ id, ... }]
  titleOverride?: string;
  subtitleOverride?: string;
}

const { lang, guias = [], titleOverride, subtitleOverride } = Astro.props;

// Base Strapi (para construir URLs absolutas de media)
const STRAPI_BASE =
  (import.meta.env.PUBLIC_STRAPI_URL?.replace("/api", "") ||
    "http://168.119.183.247:1337");

// --- i18n texts (bloque contextual de tour)
const texts = {
  es: {
    title: "Tus gu√≠as en este tour",
    subtitle: "Gu√≠as locales, cercanos y con experiencia. Te contamos historia + tips reales.",
    role: "Gu√≠a local BelgoTours",
  },
  en: {
    title: "Your guides for this tour",
    subtitle: "Local, friendly and experienced guides. History + real local tips.",
    role: "BelgoTours local guide",
  },
  it: {
    title: "Le guide di questo tour",
    subtitle: "Guide locali, simpatiche ed esperte. Storia + consigli reali.",
    role: "Guida locale BelgoTours",
  },
  fr: {
    title: "Vos guides pour ce tour",
    subtitle: "Guides locaux, sympathiques et exp√©riment√©s. Histoire + conseils locaux.",
    role: "Guide local BelgoTours",
  },
};

const t = texts[lang as keyof typeof texts] || texts.es;

const title = (titleOverride && String(titleOverride).trim()) || t.title;
const subtitle = (subtitleOverride && String(subtitleOverride).trim()) || t.subtitle;

// Helpers
function pickAttrs(entry: any) {
  return entry?.attributes ?? entry ?? {};
}

function absoluteMediaUrl(url?: string) {
  if (!url) return "";
  // si ya viene absoluta
  if (url.startsWith("http://") || url.startsWith("https://")) return url;
  return `${STRAPI_BASE}${url}`;
}

function guidePhotoUrl(foto: any) {
  // foto puede venir como { data: { attributes: { url, formats }}} o directo
  const f = foto?.data?.attributes ?? foto?.attributes ?? foto ?? null;
  if (!f) return "";

  const url =
    f.formats?.small?.url ||
    f.formats?.thumbnail?.url ||
    f.formats?.medium?.url ||
    f.url;

  return absoluteMediaUrl(url);
}

// Normalizar gu√≠as (solo activas si viene "activo")
const normalizedGuides = (Array.isArray(guias) ? guias : [])
  .map((g) => {
    const a = pickAttrs(g);
    return {
      id: g?.id ?? a?.id ?? crypto.randomUUID(),
      nombre: a?.nombre || "",
      slug: a?.slug || "",
      activo: typeof a?.activo === "boolean" ? a.activo : true,
      idiomas: Array.isArray(a?.idiomas) ? a.idiomas : [],
      fotoUrl: guidePhotoUrl(a?.foto),
    };
  })
  .filter((g) => g.activo && g.nombre);

// UI flags
const hasGuides = normalizedGuides.length > 0;

// Mostrar m√°x. 4 para no ‚Äúpesar‚Äù la p√°gina; el tour es producto, no directorio.
const guidesToShow = normalizedGuides.slice(0, 4);

// Labels idiomas (ES/EN/IT)
function normalizeLangTag(code: string) {
  const c = String(code || "").toLowerCase();
  if (!c) return "";
  return c.toUpperCase();
}

// Accesibilidad: t√≠tulo para im√°genes
function imgAlt(nombre: string) {
  return nombre ? `${nombre} - ${t.role}` : t.role;
}
---

{hasGuides && (
  <section id="guides" class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center max-w-3xl mx-auto mb-10">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
            {title}
          </h2>
          <p class="text-gray-600 text-base md:text-lg">
            {subtitle}
          </p>
        </div>

        <!-- Grid -->
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
          {guidesToShow.map((g) => (
            <article class="rounded-2xl border border-gray-100 bg-white p-6 text-center shadow-card hover:shadow-lg transition">
              <div class="flex items-center justify-center mb-4">
                {g.fotoUrl ? (
                  <img
                    src={g.fotoUrl}
                    alt={imgAlt(g.nombre)}
                    width="120"
                    height="120"
                    loading="lazy"
                    decoding="async"
                    class="w-28 h-28 rounded-full object-cover ring-2 ring-yellow-300"
                  />
                ) : (
                  <div class="w-28 h-28 rounded-full bg-gray-100 ring-4 ring-yellow-200 flex items-center justify-center text-gray-400 text-3xl">
                    üë§
                  </div>
                )}
              </div>

              <h3 class="text-lg font-bold text-gray-900">
                {g.nombre}
              </h3>

              <p class="text-sm text-yellow-600 font-semibold mt-1">
                {t.role}
              </p>

              {g.idiomas.length > 0 && (
                <div class="flex flex-wrap justify-center gap-2 mt-4">
                  {g.idiomas.map((code) => (
                    <span class="text-[11px] px-2 py-0.5 rounded-full border border-gray-200 text-gray-600 bg-gray-50">
                      {normalizeLangTag(code)}
                    </span>
                  ))}
                </div>
              )}
            </article>
          ))}
        </div>

        <!-- Nota opcional (suave) -->
        {normalizedGuides.length > 4 && (
          <div class="text-center mt-8 text-sm text-gray-500">
            {lang === "es" && "En algunos horarios puede asignarse otro gu√≠a del equipo seg√∫n disponibilidad."}
            {lang === "en" && "On some timeslots, another team guide may be assigned depending on availability."}
            {lang === "it" && "In alcune fasce orarie potrebbe essere assegnata un‚Äôaltra guida del team in base alla disponibilit√†."}
            {lang === "fr" && "Sur certains cr√©neaux, un autre guide de l‚Äô√©quipe peut √™tre attribu√© selon la disponibilit√©."}
          </div>
        )}
      </div>
    </div>
  </section>
)}
