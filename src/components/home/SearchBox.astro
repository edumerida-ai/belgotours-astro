---
interface Tour {
  name: string;
  duration: string;
  price: string;
  tourLang: "es" | "en" | "it" | "fr";
  url: string;
}

interface Props {
  lang: "es" | "en" | "it" | "fr" | "pt";
  title: string;
  subtitle: string;
  tours?: Tour[];
  ctaLabel: string;
}

const { lang, title, subtitle, tours = [], ctaLabel } = Astro.props;

/* =========================
   TEXTOS POR IDIOMA
========================= */
const TEXTS = {
  es: {
    languageLabel: "Idioma del tour",
    languagePlaceholder: "Selecciona un idiomaâ€¦",
    tourLabel: "Tour disponible",
    tourPlaceholder: "Selecciona un tourâ€¦",
    trust: [
      "âœ“ Free tours con aportaciÃ³n libre",
      "âœ“ Tours privados bajo consulta",
      "âœ“ CancelaciÃ³n gratuita",
    ],
  },
  en: {
    languageLabel: "Tour language",
    languagePlaceholder: "Select a languageâ€¦",
    tourLabel: "Available tour",
    tourPlaceholder: "Select a tourâ€¦",
    trust: [
      "âœ“ Tip-based free tours",
      "âœ“ Private tours on request",
      "âœ“ Free cancellation",
    ],
  },
  it: {
    languageLabel: "Lingua del tour",
    languagePlaceholder: "Seleziona una linguaâ€¦",
    tourLabel: "Tour disponibile",
    tourPlaceholder: "Seleziona un tourâ€¦",
    trust: [
      "âœ“ Tour gratuiti a offerta libera",
      "âœ“ Tour privati su richiesta",
      "âœ“ Cancellazione gratuita",
    ],
  },
  fr: {
    languageLabel: "Langue du tour",
    languagePlaceholder: "SÃ©lectionnez une langueâ€¦",
    tourLabel: "Tour disponible",
    tourPlaceholder: "SÃ©lectionnez un tourâ€¦",
    trust: [
      "âœ“ Free tours Ã  contribution libre",
      "âœ“ Tours privÃ©s sur demande",
      "âœ“ Annulation gratuite",
    ],
  },
  pt: {
    languageLabel: "Idioma do tour",
    languagePlaceholder: "Selecione um idiomaâ€¦",
    tourLabel: "Tour disponÃ­vel",
    tourPlaceholder: "Selecione um tourâ€¦",
    trust: [
      "âœ“ Free tours com contribuiÃ§Ã£o livre",
      "âœ“ Tours privados sob consulta",
      "âœ“ Cancelamento gratuito",
    ],
  },
};

const t = TEXTS[lang] ?? TEXTS.es;

/* =========================
   IDIOMAS DISPONIBLES
========================= */
const LANG_META: Record<string, { label: string; flag: string }> = {
  es: { label: "EspaÃ±ol", flag: "ðŸ‡ªðŸ‡¸" },
  en: { label: "English", flag: "ðŸ‡¬ðŸ‡§" },
  it: { label: "Italiano", flag: "ðŸ‡®ðŸ‡¹" },
  fr: { label: "FranÃ§ais", flag: "ðŸ‡«ðŸ‡·" },
};

const ALL_LANGS: Array<"es" | "en" | "it" | "fr"> = ["es", "en", "it", "fr"];
const uid = `sb-${Math.random().toString(36).slice(2)}`;
---

<section class="relative z-10" data-searchbox={uid}>
  <div class="max-w-5xl mx-auto bg-white rounded-3xl border border-neutral-200 shadow-soft p-6 md:p-8">

    <!-- TÃTULO -->
    <header class="text-center mb-8">
      <h3 class="text-2xl md:text-3xl font-bold text-neutral-900">{title}</h3>
      <p class="text-neutral-600 mt-1">{subtitle}</p>
    </header>

    <!-- FORM -->
    <div class="grid md:grid-cols-3 gap-4 items-end">

      <!-- IDIOMA -->
      <div class="relative">
        <label class="block text-sm font-medium text-neutral-700 mb-2">
          {t.languageLabel}
        </label>

        <button
          type="button"
          data-lang-trigger
          class="w-full h-[52px] px-4 flex items-center justify-between rounded-xl border border-neutral-300 bg-white text-neutral-800 hover:border-neutral-400 transition"
        >
          <span data-lang-label class="text-neutral-500">
            {t.languagePlaceholder}
          </span>
          <svg class="w-4 h-4 text-neutral-400" fill="none" viewBox="0 0 24 24">
            <path d="M19 9l-7 7-7-7" stroke="currentColor" stroke-width="2" />
          </svg>
        </button>

        <div
          data-lang-dropdown
          class="absolute left-0 right-0 mt-2 p-3 bg-white border border-neutral-200 rounded-xl shadow-xl flex gap-3 justify-center opacity-0 pointer-events-none transition z-20"
        >
          {ALL_LANGS.map(code => (
            <button
              type="button"
              class="lang-pill w-11 h-11 rounded-full border border-neutral-200 bg-white hover:shadow-md transition flex items-center justify-center text-xl"
              data-lang={code}
              aria-label={LANG_META[code].label}
              title={LANG_META[code].label}
            >
              {LANG_META[code].flag}
            </button>
          ))}
        </div>
      </div>

      <!-- TOUR -->
      <div>
        <label class="block text-sm font-medium text-neutral-700 mb-2">
          {t.tourLabel}
        </label>

        <select
          data-tour-select
          disabled
          class="w-full h-[52px] rounded-xl border border-neutral-300 px-4 text-neutral-800 bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-neutral-900"
        >
          <option value="">{t.tourPlaceholder}</option>
        </select>
      </div>

      <!-- CTA -->
      <div>
        <button
          data-search-button
          disabled
          class="w-full h-[52px] rounded-xl bg-neutral-900 text-white font-semibold hover:bg-black transition disabled:opacity-40"
        >
          {ctaLabel}
        </button>
      </div>
    </div>

    <!-- MICRO CONFIANZA -->
    <div class="flex flex-wrap justify-center gap-6 text-xs text-neutral-500 mt-6">
      {t.trust.map(item => (
        <span>{item}</span>
      ))}
    </div>
  </div>
</section>

<script define:vars={{ tours, LANG_META, uid, t }}>
  const root = document.querySelector(`[data-searchbox="${uid}"]`);
  if (!root) return;

  const trigger = root.querySelector("[data-lang-trigger]");
  const dropdown = root.querySelector("[data-lang-dropdown]");
  const label = root.querySelector("[data-lang-label]");
  const pills = root.querySelectorAll(".lang-pill");
  const tourSelect = root.querySelector("[data-tour-select]");
  const button = root.querySelector("[data-search-button]");

  let selectedLang = null;

  const closeDropdown = () => {
    dropdown.classList.add("opacity-0", "pointer-events-none");
  };

  trigger.addEventListener("click", () => {
    dropdown.classList.toggle("opacity-0");
    dropdown.classList.toggle("pointer-events-none");
  });

  pills.forEach(pill => {
    pill.addEventListener("click", () => {
      selectedLang = pill.dataset.lang;
      label.textContent = LANG_META[selectedLang].label;
      closeDropdown();

      tourSelect.innerHTML = `<option value="">${t.tourPlaceholder}</option>`;
      const filtered = tours.filter(t => t.tourLang === selectedLang);

      filtered.forEach(tour => {
        const opt = document.createElement("option");
        opt.value = tour.url;
        opt.textContent = `${tour.name} â€¢ ${tour.duration} â€¢ ${tour.price}`;
        tourSelect.appendChild(opt);
      });

      tourSelect.disabled = false;
      tourSelect.classList.remove("bg-neutral-100");
      tourSelect.classList.add("bg-white");
      button.disabled = true;
    });
  });

  tourSelect.addEventListener("change", () => {
    button.disabled = !tourSelect.value;
  });

  button.addEventListener("click", () => {
    if (tourSelect.value) window.location.href = tourSelect.value;
  });

  document.addEventListener("click", e => {
    if (!root.contains(e.target)) closeDropdown();
  });
</script>
