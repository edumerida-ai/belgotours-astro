---
export const prerender = false; // FIX DEFINITIVO

import Layout from "../../layouts/Layout.astro";
import { DateTime } from "luxon";

const { lang } = Astro.params;

// Leer ID desde ?id=24
const reservaId = Astro.url.searchParams.get("id");

const STRAPI_URL =
  import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337/api";

let reserva = null;
let error = null;

let fechaFormateada = "";
let horaFormateada = "";

// =============================
// Traducciones UI
// =============================
const T = {
  pageTitle: {
    es: "Detalle de tu reserva",
    en: "Your booking details",
    it: "Dettagli della tua prenotazione",
    fr: "D√©tails de votre r√©servation",
  },
  instructions: {
    es: "Guarda esta p√°gina o comp√°rtela con tu grupo. Aqu√≠ tienes toda la informaci√≥n importante.",
    en: "Save this page or share it with your group. Here is all the important information.",
    it: "Salva questa pagina o condividila con il tuo gruppo. Qui trovi tutte le informazioni importanti.",
    fr: "Enregistrez cette page ou partagez-la avec votre groupe. Voici toutes les informations importantes.",
  },
  meetingPoint: {
    es: "üìç Punto de encuentro",
    en: "üìç Meeting point",
    it: "üìç Punto d'incontro",
    fr: "üìç Point de rendez-vous",
  },
  openMaps: {
    es: "Abrir en Google Maps",
    en: "Open in Google Maps",
    it: "Apri in Google Maps",
    fr: "Ouvrir dans Google Maps",
  },
  tourSummary: {
    es: "Resumen del tour",
    en: "Tour summary",
    it: "Riepilogo del tour",
    fr: "R√©sum√© du tour",
  },
  viewEdit: {
    es: "Modificar reserva",
    en: "Edit booking",
    it: "Modifica prenotazione",
    fr: "Modifier la r√©servation",
  },
  whatsapp: {
    es: "Compartir por WhatsApp",
    en: "Share via WhatsApp",
    it: "Condividi via WhatsApp",
    fr: "Partager via WhatsApp",
  },
  back: {
    es: "Volver a BelgoTours",
    en: "Back to BelgoTours",
    it: "Torna a BelgoTours",
    fr: "Retour √† BelgoTours",
  },
  error: {
    es: "No se pudo cargar la reserva.",
    en: "Could not load booking.",
    it: "Impossibile caricare la prenotazione.",
    fr: "Impossible de charger la r√©servation.",
  },
  labels: {
    tour: { es: "Tour", en: "Tour", it: "Tour", fr: "Visite" },
    date: { es: "Fecha", en: "Date", it: "Data", fr: "Date" },
    time: { es: "Horario", en: "Time", it: "Orario", fr: "Horaire" },
    participants: {
      es: "Participantes",
      en: "Participants",
      it: "Partecipanti",
      fr: "Participants",
    },
    language: { es: "Idioma", en: "Language", it: "Lingua", fr: "Langue" },
  },
  mapHint: {
    es: "Llega 10‚Äì15 minutos antes para encontrar al gu√≠a con el paraguas de BelgoTours.",
    en: "Arrive 10‚Äì15 minutes early to find the guide with the BelgoTours umbrella.",
    it: "Arriva 10‚Äì15 minuti prima per trovare la guida con l‚Äôombrello di BelgoTours.",
    fr: "Arrivez 10 √† 15 minutes en avance pour trouver le guide avec le parapluie BelgoTours.",
  },
};

// =============================
// Cargar reserva desde Strapi
// =============================
if (!reservaId) {
  error = T.error[lang];
} else {
  try {
    const url = `${STRAPI_URL}/reservas/public/${encodeURIComponent(
      reservaId
    )}?populate[tour]=*`;
    const res = await fetch(url);

    if (!res.ok) {
  error = T.error[lang];
} else {
  const json = await res.json();
  reserva = json?.data || null;

  if (!reserva) {
    error = T.error[lang];
  } else if (reserva.fecha_hora_tour) {
    const dt = DateTime.fromISO(reserva.fecha_hora_tour, {
      zone: "Europe/Brussels"
    });

    fechaFormateada = dt.setLocale(lang).toLocaleString(DateTime.DATE_FULL);
    horaFormateada = dt.toFormat("HH:mm");
  }
}
  } catch (e) {
    console.error(e);
    error = T.error[lang];
  }
}

// =============================
// Mapa Google
// =============================
const MAPA_PUNTO_ENCUENTRO =
  import.meta.env.PUBLIC_MAPA_INICIO ||
  "https://www.google.com/maps?q=Grand+Place+8+Bruxelles";
---

<Layout lang={lang}>
  <main class="min-h-screen bg-gray-50 py-10 px-4">
    <div class="max-w-5xl mx-auto">

      {error ? (
        <div class="bg-white p-10 rounded-3xl shadow-xl text-center">
          <h1 class="text-3xl font-bold text-red-600 mb-6">{error}</h1>
          <a
            href={`/${lang}/`}
            class="inline-block px-6 py-3 rounded-xl bg-gray-900 text-white font-semibold hover:bg-gray-800"
          >
            {T.back[lang]}
          </a>
        </div>
      ) : (
        <>
          <!-- ENCABEZADO -->
          <div class="mb-6">
            <h1 class="text-4xl font-bold text-gray-900">
              {T.pageTitle[lang]}
            </h1>
            <p class="text-gray-600">{T.instructions[lang]}</p>
          </div>

          <!-- MAPA -->
          <div class="bg-white rounded-3xl shadow-lg border border-gray-200 overflow-hidden mb-8">
            <iframe
              src={`${MAPA_PUNTO_ENCUENTRO}&output=embed`}
              class="w-full h-[360px]"
              loading="lazy"
            ></iframe>

            <div class="p-5 border-t border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <p class="text-gray-900 font-semibold text-lg">
                  Grand Place 8, 1000 Bruxelles
                </p>
                <p class="text-gray-600 text-sm">
                  {T.mapHint[lang]}
                </p>
              </div>

              <a
                href={MAPA_PUNTO_ENCUENTRO}
                target="_blank"
                class="px-5 py-3 rounded-xl bg-gray-900 text-white font-semibold hover:bg-gray-800 text-sm"
              >
                {T.openMaps[lang]}
              </a>
            </div>
          </div>

          <!-- RESUMEN -->
          <div class="bg-white rounded-3xl shadow-lg p-8 border border-gray-200 mb-10">
            <h2 class="text-2xl font-bold mb-4">{T.tourSummary[lang]}</h2>

            <div class="grid grid-cols-2 gap-y-2 text-gray-700 text-sm">
              <p class="font-medium">{T.labels.tour[lang]}</p>
              <p>{reserva.tour?.titulo}</p>

              <p class="font-medium">{T.labels.date[lang]}</p>
              <p>{fechaFormateada}</p>

              <p class="font-medium">{T.labels.time[lang]}</p>
              <p>{horaFormateada}</p>

              <p class="font-medium">{T.labels.participants[lang]}</p>
              <p>
                {reserva.adultos} adultos, {reserva.ninos} ni√±os
              </p>

              <p class="font-medium">{T.labels.language[lang]}</p>
              <p>{reserva.idioma_tour?.toUpperCase()}</p>
            </div>
          </div>

          <!-- ACCIONES -->
          <div class="space-y-4">
            <a
              href={`/${lang}/booking-edit?id=${reserva.id}`}
              class="w-full block text-center px-6 py-4 rounded-xl bg-amber-500 text-white font-semibold hover:bg-amber-600"
            >
              {T.viewEdit[lang]}
            </a>

            <a
              href={`https://wa.me/32489829468?text=${encodeURIComponent(
                `Hola BelgoTours üëã

                  Reserva #${reserva.id}
                  Tour: ${reserva.tour?.titulo}
                  Fecha: ${fechaFormateada}
                  Hora: ${horaFormateada}
                  Participantes: ${reserva.adultos} adultos, ${reserva.ninos} ni√±os`
                  )}`}
              target="_blank"
              class="w-full block text-center px-6 py-4 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700"
            >
              {T.whatsapp[lang]}
            </a>

            <a
              href={`/${lang}/`}
              class="block text-center px-6 py-4 rounded-xl bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300"
            >
              {T.back[lang]}
            </a>
          </div>
        </>
      )}
    </div>
  </main>
</Layout>
