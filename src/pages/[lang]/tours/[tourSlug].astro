

---
export const prerender = false;



import { getTourBySlug, getTourSlugs } from "../../../lib/api.js";
import Layout from "@/layouts/Layout.astro";

import TourHeader from "../../../components/TourHeader.astro";
import Footer from "../../../components/Footer.astro";

import ReviewsPro from "@/components/reviews-pro/ReviewsPro.astro";
// import GuidesSection from "../../../components/GuidesSection.astro";
import GuidesSectionTour from "../../../components/tours/GuidesSectionTour.astro";


import AIAssistant from "../../../components/tours/AIAssistant.astro";
import GamificationSystem from "../../../components/tours/GamificationSystem.astro";

import BookingForm from "../../../components/booking/BookingForm.astro";


/* =========================================================
IMPORTANT: enable SSG prerender for getStaticPaths()
========================================================= */


/* =========================================================
STATIC PATHS
========================================================= */


/* =========================================================
FETCH TOUR
========================================================= */
const { tourSlug, lang: rawLang } = Astro.params;
console.log("PARAMS:", Astro.params);
console.log("ENV:", import.meta.env.PUBLIC_STRAPI_URL);


type Lang = "es" | "en" | "it" | "fr";

const lang: Lang =
  rawLang && ["es", "en", "it", "fr"].includes(rawLang)
    ? (rawLang as Lang)
    : "es";

const tourData = await getTourBySlug(tourSlug, lang);

if (!tourData) {
  return new Response(null, {
    status: 302,
    headers: { Location: `/${lang}/404/` },
  });
}

/* =========================================================
FETCH REVIEWS (para JSON-LD din√°mico real)
========================================================= */
const STRAPI_API =
  import.meta.env.PUBLIC_STRAPI_URL ||
  process.env.PUBLIC_STRAPI_URL ||
  "https://api.belgotours.com/api";

let reviewsData = null;

try {
  const res = await fetch(
    `${STRAPI_API}/public/reviews-pro?tour=${tourSlug}&lang=${lang}`
  );

  if (res.ok) {
    reviewsData = await res.json();
  } else {
    console.error("‚ùå Error HTTP reviews schema:", res.status);
  }
} catch (e) {
  console.error("‚ùå Error loading reviews schema", e);
}

/* =========================================================
NORMALIZE REVIEWS DATA
========================================================= */
const rating =
  Number(reviewsData?.summary?.rating) || 0;

const reviewCount =
  Number(reviewsData?.summary?.total) || 0;

const topReviews =
  Array.isArray(reviewsData?.reviews)
    ? reviewsData.reviews.slice(0, 3)
    : [];


// Compat Strapi v4/v5
const attrs = tourData.attributes ?? tourData;
const tourId = tourData.id ?? attrs?.id ?? null;

/* =========================================================
MEDIA HELPER (SAFE ¬∑ STAGING & PROD)
========================================================= */
function mediaUrl(
  media: any,
  preferredSize: "large" | "medium" | "small" = "large"
): string {
  if (!media) return "";

  // Usamos SIEMPRE la base real que ya conoce Astro
  const apiBase =
    (import.meta.env.PUBLIC_STRAPI_URL || "")
      .replace(/\/api\/?$/, "")
      .replace(/\/$/, "");

  const path =
    media?.formats?.[preferredSize]?.url ||
    media?.formats?.medium?.url ||
    media?.formats?.small?.url ||
    media?.url ||
    "";

  // Si Strapi ya devuelve URL absoluta ‚Üí la respetamos
  if (path.startsWith("http://") || path.startsWith("https://")) {
    return path;
  }

  // Si no, construimos URL segura (sin forzar protocolo)
  return path ? `${apiBase}${path}` : "";
}

/* =========================================================
NORMALIZATION
========================================================= */
const heroConfig = attrs.hero_config || {};
const heroMedia = attrs.hero_media || {};

// En tu Strapi schema aparece como repeatable:true (pero el JSON que pegaste NO tiene array).
// Para robustez: aceptamos objeto o array.
const elementosUnicosRaw =
attrs.elementos_unicos ?? attrs.elementosUnicos ?? null;

const elementosUnicos = Array.isArray(elementosUnicosRaw)
? elementosUnicosRaw[0] || {}
: (elementosUnicosRaw || {});

/* =========================================================
BUSINESS LOGIC
========================================================= */
const tipoTour = attrs.tipo_tour || "free"; // free | privado | especial
const isPrivate = tipoTour === "privado";
const isSpecial = tipoTour === "especial";
const isFree = tipoTour === "free" && attrs.pago_libre === true;
const isFixed = !isPrivate && !isFree;

/* =========================================================
TOUR OBJECT (normalized)
========================================================= */
const tour = {
id: tourId,
slug: attrs.slug,
titulo: attrs.titulo || "Sin t√≠tulo",
subtitulo: attrs.subtitulo || "",
seoH1: attrs.seo_h1 || "",
claimHero: attrs.claim_hero || "",
descripcion: attrs.descripcion || "",
ciudad: attrs.ciudad || "", // bruselas|brujas
idioma: Array.isArray(attrs.idiomas) ? attrs.idiomas[0] : (attrs.idioma || null),

duracion: attrs.duracion ?? null,
maxPersonas: attrs.maxPersonas || 25,

// pricing
pagoLibre: attrs.pago_libre === true,
precioBase: Number(attrs.precio_base ?? attrs.precio ?? 0),
moneda: attrs.moneda || "‚Ç¨",

// meeting point + geo
puntoEncuentro: attrs.punto_encuentro || "",
lat: attrs.coordenadas_lat ?? null,
lng: attrs.coordenadas_lng ?? null,

// ratings

// hero
heroMedia: {
imagen: mediaUrl(heroMedia?.imagen, "large"),
video: heroMedia?.video || "",
},

heroConfig,

badges: String(heroConfig?.badges || "")
.split(",")
.map((b) => b.trim())
.filter(Boolean),

elementosUnicos,

itinerario: (attrs.itinerarios || []).map((p: any) => ({
titulo: p.titulo || "",
duracion: p.duracion || "",
descripcion: p.descripcion || "",
icono: p.icono || "",
imagen: mediaUrl(p.imagen, "medium"),
})),

// üëá preparado para gu√≠as (NO se usa a√∫n)
guias: Array.isArray(attrs.guias)
  ? attrs.guias
  : attrs.guias?.data || [],


// SEO fields
seoTitle: attrs.seo_title || "",
seoDescription: attrs.seo_description || "",
seoCanonical: attrs.seo_canonical || "",
mostrarRatingHero: attrs.mostrar_rating_hero === true,
};

/* =========================================================
I18N UI TEXTS
========================================================= */
const ui = {
es: {
reservar: isPrivate ? "Solicitar tour privado" : "Reservar ahora",
verDisponibilidad: "Ver disponibilidad",
overview: "Descripci√≥n",
itinerario: "Itinerario",
itinerarioIntro: "Descubre los lugares que visitaremos paso a paso durante el recorrido",
puntoEncuentro: "Punto de encuentro",
reviews: "Rese√±as",
verEnMapa: "Ver en Google Maps",
consultaWhatsApp: "Consulta por WhatsApp",
aportacionLibre: "Aportaci√≥n libre",
tuDecides: "T√∫ decides al final",
pagoAlGuia: "Pago al gu√≠a",
presupuesto: "Presupuesto",
microPrivate: "Te contactamos por WhatsApp para definir fecha y precio",
},
en: {
reservar: isPrivate ? "Request private tour" : "Book now",
verDisponibilidad: "Check availability",
overview: "Overview",
itinerario: "Itinerary",
itinerarioIntro: "Discover the places we will visit step by step during the tour",
puntoEncuentro: "Meeting point",
reviews: "Reviews",
verEnMapa: "Open in Google Maps",
consultaWhatsApp: "Ask on WhatsApp",
aportacionLibre: "Pay what you want",
tuDecides: "You decide at the end",
pagoAlGuia: "Pay the guide",
presupuesto: "Quote",
microPrivate: "We‚Äôll contact you via WhatsApp to define date & price",
},
it: {
reservar: isPrivate ? "Richiedi tour privato" : "Prenota ora",
verDisponibilidad: "Vedi disponibilit√†",
overview: "Descrizione",
itinerario: "Itinerario",
itinerarioIntro: "Scopri i luoghi che visiteremo passo dopo passo durante il tour",
puntoEncuentro: "Punto d‚Äôincontro",
reviews: "Recensioni",
verEnMapa: "Apri in Google Maps",
consultaWhatsApp: "Chiedi su WhatsApp",
aportacionLibre: "Offerta libera",
tuDecides: "Decidi alla fine",
pagoAlGuia: "Paghi la guida",
presupuesto: "Preventivo",
microPrivate: "Ti contatteremo su WhatsApp per data e prezzo",
},
fr: {
reservar: "Demander un tour priv√©",
verDisponibilidad: "Voir disponibilit√©s",
overview: "Description",
itinerario: "Itin√©raire",
itinerarioIntro: "D√©couvrez les lieux que nous visiterons √©tape par √©tape pendant la visite",
puntoEncuentro: "Point de rencontre",
reviews: "Avis",
verEnMapa: "Ouvrir Google Maps",
consultaWhatsApp: "Demander sur WhatsApp",
aportacionLibre: "Contribution libre",
tuDecides: "Vous d√©cidez √† la fin",
pagoAlGuia: "Paiement au guide",
presupuesto: "Devis",
microPrivate: "On vous contacte sur WhatsApp pour d√©finir date et prix",
},
}[lang] || {
reservar: "Reservar ahora",
verDisponibilidad: "Ver disponibilidad",
overview: "Descripci√≥n",
itinerario: "Itinerario",
puntoEncuentro: "Punto de encuentro",
reviews: "Rese√±as",
verEnMapa: "Ver en Google Maps",
consultaWhatsApp: "Consulta por WhatsApp",
aportacionLibre: "Aportaci√≥n libre",
tuDecides: "T√∫ decides al final",
pagoAlGuia: "Pago al gu√≠a",
presupuesto: "Presupuesto",
microPrivate: "Te contactamos por WhatsApp para definir fecha y precio",
};

/* =========================================================
HERO COPY + FORMATTING
========================================================= */
function formatDuration(value: number | null | undefined): string {
if (value === null || value === undefined) return "";
const n = Number(value);
if (Number.isNaN(n)) return "";
const h = Math.floor(n / 60);
const m = n % 60;
if (!h) return `${m} min`;
if (!m) return `${h} h`;
return `${h} h ${m} min`;
}

const durationLabel = formatDuration(tour.duracion);
const langLabel = tour.idioma ? String(tour.idioma).toUpperCase() : "";
const cityLabel = tour.ciudad ? String(tour.ciudad).toUpperCase() : "";

// Subtitle fallback (NO es heading)
const heroSubtitleFallback: Record<
  Lang,
  {
    free: string;
    fixed: string;
    private: string;
    special: string;
  }
> = {
  es: {
    free: "Historia, arquitectura y rincones ocultos con gu√≠as locales.",
    fixed: "Una experiencia cuidada con gu√≠as locales.",
    private: "Tour privado a tu ritmo con gu√≠a local.",
    special: "Una experiencia √∫nica y deliciosa en B√©lgica.",
  },
  en: {
    free: "History, architecture and hidden corners with local guides.",
    fixed: "A curated experience with local guides.",
    private: "Private tour at your pace with a local guide.",
    special: "A unique and delicious Belgian experience.",
  },
  it: {
    free: "Storia, architettura e angoli nascosti con guide locali.",
    fixed: "Un‚Äôesperienza curata con guide locali.",
    private: "Tour privato al tuo ritmo con guida locale.",
    special: "Un‚Äôesperienza belga unica e gustosa.",
  },
  fr: {
    free: "Histoire, architecture et coins cach√©s avec des guides locaux.",
    fixed: "Une exp√©rience soign√©e avec des guides locaux.",
    private: "Visite priv√©e √† votre rythme avec un guide local.",
    special: "Une exp√©rience belge unique et savoureuse.",
  }
};
const subtitleKey = isPrivate ? "private" : isSpecial ? "special" : isFree ? "free" : "fixed";

const heroSubtitle =
(tour.subtitulo && tour.subtitulo.trim()) ||
heroSubtitleFallback[lang]?.[subtitleKey] ||
heroSubtitleFallback.es.free;

const heroClaim =
(tour.claimHero && String(tour.claimHero).trim()) ||
heroSubtitle;

// Pricing hero
const heroPriceTitle = isPrivate
? ui.presupuesto
: isFree
? ui.aportacionLibre
: `${tour.precioBase}${tour.moneda}`;

const heroPriceNote = isPrivate
? ui.consultaWhatsApp
: isFree
? ui.tuDecides
: ui.pagoAlGuia;

// CTA mode
const heroCtaMode = isPrivate ? "private-request" : "booking";
const heroCtaText = ui.reservar;
const heroCtaMicro = isPrivate ? ui.microPrivate : "";

/* =========================================================
MAP LINKS
========================================================= */
const mapsUrl = (() => {
if (tour.lat && tour.lng) {
return `https://www.google.com/maps?q=${tour.lat},${tour.lng}`;
}
if (tour.puntoEncuentro) {
return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(tour.puntoEncuentro)}`;
}
return "";
})();

/* =========================================================
REVIEWS (schema gating)
========================================================= */


/* =========================================================
SEO (title/description/canonical)
========================================================= */
const metaTitle =
(tour.seoTitle && tour.seoTitle.trim()) ||
`${tour.titulo} | BelgoTours`;

const metaDescription =
(tour.seoDescription && tour.seoDescription.trim()) ||
heroSubtitle;

const canonicalUrl =
(tour.seoCanonical && tour.seoCanonical.trim()) ||
`https://belgotours.com/${lang}/tours/${tour.slug}/`;

// Minimal JSON-LD (luego lo refinamos con @type correcto y reviews)
const tourSchema =
reviewCount > 0
  ? {
      "@context": "https://schema.org",
      "@type": "Product",
      "@id": `${canonicalUrl}#product`,
      url: canonicalUrl,
      name: tour.titulo,
      description: metaDescription,
      image: tour.heroMedia?.imagen
        ? [tour.heroMedia.imagen]
        : undefined,

      brand: {
        "@type": "Organization",
        name: "BelgoTours",
        url: "https://belgotours.com"
      },

      provider: {
        "@type": "Organization",
        name: "BelgoTours",
        url: "https://belgotours.com"
      },

      areaServed: {
        "@type": "City",
        name: tour.ciudad === "bruselas" ? "Brussels" : "Bruges"
      },

      inLanguage: lang,

      offers: {
        "@type": "Offer",
        priceCurrency: "EUR",
        price: tour.precioBase && tour.precioBase > 0
          ? String(tour.precioBase)
          : "0",
        availability: "https://schema.org/InStock",
        url: canonicalUrl
      },

      aggregateRating: {
        "@type": "AggregateRating",
        ratingValue: rating.toFixed(1),
        reviewCount: reviewCount,
        bestRating: "5",
        worstRating: "1"
      },

      review: topReviews.map((r: any) => ({
        "@type": "Review",
        author: {
          "@type": "Person",
          name: r.nombre || "Traveler"
        },
        datePublished: r.fecha,
        reviewBody: r.comentario || "",
        reviewRating: {
          "@type": "Rating",
          ratingValue: String(r.rating),
          bestRating: "5",
          worstRating: "1"
        }
      }))
    }
  : null;
  ---

<Layout
title={metaTitle}
description={metaDescription}
canonical={canonicalUrl}
>
{tourSchema && (
<script type="application/ld+json">
{JSON.stringify(tourSchema)}
</script>
)}

<!-- 1) HEADER (global) -->
<div slot="header">
<TourHeader lang={lang} />
</div>

<!-- 2) HERO (din√°mico desde Strapi) -->
<section class="relative min-h-[80vh] md:min-h-screen flex items-center justify-center overflow-hidden">
<div class="absolute inset-0 z-0">
{tour.heroMedia?.video ? (
<video
class="w-full h-full object-cover"
src={tour.heroMedia.video}
autoplay
muted
loop
playsinline
/>
) : tour.heroMedia?.imagen ? (
<img
src={tour.heroMedia.imagen}
alt={tour.titulo}
class="w-full h-full object-cover"
loading="eager"
decoding="async"
/>
) : (
<div class="w-full h-full bg-gray-700"></div>
)}
<div class="absolute inset-0 bg-black/45 md:bg-black/50"></div>
</div>

<div class="container relative z-10 mx-auto px-4 py-14 md:py-20">
<div class="max-w-4xl mx-auto text-center text-white">
<!-- Badges -->
<div class="flex flex-wrap justify-center gap-3 mb-6">
{tour.badges?.map((badge) => (
<span class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-full text-sm font-bold">
{badge}
</span>
))}

{tour.elementosUnicos?.gamificacion && (
<span class="bg-purple-500 text-white px-4 py-2 rounded-full text-sm font-bold">
üéÆ TOUR GAMIFICADO
</span>
)}
</div>

<!-- H1 -->
<h1 class="text-4xl md:text-6xl lg:text-7xl font-extrabold leading-tight tracking-tight mb-5 md:mb-6">
{tour.seoH1 || tour.titulo}
</h1>

<!-- Claim (NO heading) -->
<p class="text-lg md:text-xl lg:text-2xl mb-6 md:mb-8 text-white/85 max-w-2xl mx-auto">
{heroClaim}
</p>

<!-- Chips -->
<div class="flex flex-wrap justify-center items-center gap-3 text-sm md:text-base text-white/80 mb-8">
{heroConfig?.mostrar_duracion !== false && durationLabel && (
<span>‚è±Ô∏è {durationLabel}</span>
)}
{/*
{heroConfig?.mostrar_max_personas !== false && tour.maxPersonas && (
  <span>üë• {tour.maxPersonas}</span>
)}
*/}

{langLabel && <span>üåç {langLabel}</span>}
{cityLabel && <span>üèôÔ∏è {cityLabel}</span>}
</div>

<!-- CTA Card -->
<div class="bg-white/10 backdrop-blur-md rounded-2xl p-5 md:p-8 max-w-xl mx-auto border border-white/20 shadow-xl">
<div class="flex flex-col md:flex-row items-center justify-between gap-6">
<div class="text-center md:text-left">
<div class="text-3xl font-bold text-yellow-400 mb-1">
{heroPriceTitle}
</div>
<div class="text-white/80 text-sm">
{heroPriceNote}
</div>
{heroCtaMicro && (
<p class="mt-3 text-sm text-white/80">{heroCtaMicro}</p>
)}
</div>

<div class="flex flex-col gap-3 w-full md:w-auto">
<button
type="button"
class={`${heroCtaMode === "booking" ? "openBookingBtn" : "openPrivateRequestBtn"}
bg-yellow-400 hover:bg-yellow-300
text-gray-900 font-extrabold
text-base md:text-lg
px-6 py-3 md:px-8 md:py-4
rounded-xl
transition-all duration-300
hover:scale-[1.02]
shadow-xl
inline-flex items-center justify-center gap-2
w-full md:w-auto`}
aria-expanded="false"
>
<span>üóìÔ∏è {heroCtaText}</span>
</button>

{heroCtaMode === "private-request" && mapsUrl && (
<a
href={mapsUrl}
target="_blank"
rel="noopener"
class="bg-white/10 hover:bg-white/20 border border-white/30 text-white font-semibold px-8 py-3 rounded-xl transition duration-300 inline-flex items-center justify-center gap-2"
>
<span>üìç {ui.verEnMapa}</span>
</a>
)}
</div>
</div>
{/* 
{tour.puntoEncuentro && (
<div class="mt-6 pt-6 border-t border-white/15 text-sm text-white/85 text-left">
<div class="font-semibold mb-1">üìç {ui.puntoEncuentro}</div>
<div class="opacity-90">{tour.puntoEncuentro}</div>
</div>
)}
*/}
</div>
</div>
</div>

<div class="absolute bottom-8 left-1/2 -translate-x-1/2 animate-bounce text-white/60 text-2xl">
‚¨áÔ∏è
</div>
</section>

<!-- 3) DESCRIPCI√ìN / OVERVIEW -->
<section
  id="overview"
  class="py-12 md:py-20 bg-gray-50 md:bg-white"
>
  <div class="container mx-auto px-4">

    <!-- T√≠tulo + subt√≠tulo (editorial, centrado) -->
    <div class="max-w-3xl mx-auto text-center mb-8 md:mb-14">
      <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight">
        {ui.overview}
      </h2>
      <p class="mt-4 text-base md:text-lg text-gray-600">
        {heroSubtitle}
      </p>
    </div>

    <!-- Card de contenido (premium, lectura c√≥moda) -->
    <div class="max-w-3xl mx-auto">
      <div
        class="bg-white rounded-2xl p-6 md:p-10 shadow-soft"
      >
        <div
          class="prose prose-lg md:prose-xl max-w-none text-gray-700
                 prose-p:leading-relaxed
                 prose-p:my-5
                 prose-strong:text-gray-900
                 prose-h3:text-xl
                 prose-h3:mt-8
                 prose-h3:mb-3"
        >
          {tour.descripcion ? (
            <div set:html={tour.descripcion} />
          ) : (
            <p>{heroSubtitle}</p>
          )}
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Separador suave hacia Itinerario -->

<!-- 4) ITINERARIO -->
<section id="itinerario" class="py-16 md:py-20 bg-gray-50">
  <div class="container mx-auto px-4">

    <!-- T√≠tulo de secci√≥n (mejor jerarqu√≠a + centrado) -->
    <div class="max-w-3xl mx-auto text-center mb-12">
      <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight">
        {ui.itinerario}
      </h2>
      <p class="mt-3 text-base md:text-lg text-gray-600">
  {ui.itinerarioIntro}
</p>

    </div>

    <!-- Lista de paradas -->
    <div class="max-w-4xl mx-auto space-y-8 md:space-y-12">
      {tour.itinerario?.map((punto: any, index: number) => (
        <article class="bg-white rounded-3xl shadow-card overflow-hidden">
          <div class="grid grid-cols-1 md:grid-cols-2">

            <!-- Imagen -->
            <div class="relative">
              {punto.imagen ? (
                <img
                  src={punto.imagen}
                  alt={punto.titulo}
                  class="w-full h-64 md:h-full object-cover"
                  loading="lazy"
                  decoding="async"
                />
              ) : (
                <div class="w-full h-64 md:h-full bg-gray-200"></div>
              )}

              <!-- N√∫mero de parada (SIN #, estilo premium) -->
              <div class="absolute top-4 left-4 w-9 h-9 rounded-full bg-black/70 text-white flex items-center justify-center text-sm font-semibold">
                {index + 1}
              </div>
            </div>

            <!-- Contenido -->
            <div class="p-6 md:p-10 flex flex-col justify-center">
              <h3 class="text-2xl font-bold text-gray-900 mb-2">
                {punto.titulo}
              </h3>

              {punto.duracion && (
                <div class="text-sm text-gray-500 mb-4 flex items-center gap-1">
                  ‚è±Ô∏è <span>{punto.duracion}</span>
                </div>
              )}

              <p class="text-gray-700 leading-relaxed text-base md:text-lg">
                {punto.descripcion}
              </p>
            </div>

          </div>
        </article>
      ))}
    </div>

  </div>
</section>


<!-- 5) MAPA / PUNTO DE ENCUENTRO -->
<section id="mapa" class="py-16 md:py-20 bg-gradient-to-b from-gray-900 to-gray-800 text-white">
  <div class="container mx-auto px-4">
    <div class="max-w-4xl mx-auto">

      <!-- T√≠tulo -->
      <h2 class="text-3xl md:text-4xl font-extrabold mb-8 tracking-tight">
        {ui.puntoEncuentro}
      </h2>

      <!-- Card -->
      <div class="rounded-2xl bg-white/5 backdrop-blur-md border border-white/10 p-6 md:p-8 shadow-soft">

        <!-- Direcci√≥n -->
        <p class="text-lg font-medium mb-5 text-white">
          {tour.puntoEncuentro || "‚Äî"}
        </p>

        <!-- CTA Maps -->
        {mapsUrl && (
          <a
            href={mapsUrl}
            target="_blank"
            rel="noopener"
            class="inline-flex items-center gap-2 bg-brand-yellow text-brand-black font-bold px-6 py-3 rounded-xl hover:bg-brand-yellow-dark transition"
          >
            üìç {ui.verEnMapa}
          </a>
        )}

        <!-- Tip -->
        <div class="mt-6 text-sm text-white/70">
          Tip: llega al menos 10 minutos antes para empezar sin prisas.
        </div>

      </div>
    </div>
  </div>
</section>

<!-- 6) RESE√ëAS -->
<section id="reviews" class="py-16 md:py-20 bg-white">
  <div class="container mx-auto px-4">
    <div class="max-w-6xl mx-auto">

      <!-- T√≠tulo + subt√≠tulo (jerarqu√≠a clara) -->
      <div class="mb-10">
        <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight">
          {ui.reviews}
        </h2>
        <p class="mt-2 text-base md:text-lg text-gray-600">
          Opiniones reales y verificadas de viajeros.
        </p>
      </div>

      <!-- Reviews -->
      <ReviewsPro lang={lang} tourSlug={tour.slug} />

    </div>
  </div>
</section>

<!-- 7) GU√çAS DEL TOUR -->
<GuidesSectionTour lang={lang} guias={tour.guias} />

<!-- 8) CTA PERSISTENTE (UX PREMIUM ¬∑ TOUR PAGES) -->
<div
  id="bookingWidget"
  class="fixed bottom-3 left-3 right-3
         md:left-auto md:right-10 md:bottom-8
         z-40 transition-all duration-300
         max-w-xl mx-auto md:max-w-none"
>
  <div
  class="bg-white/95 backdrop-blur-md
         border border-gray-200
         shadow-xl
         rounded-2xl
         flex items-center justify-center md:justify-end
         px-3 py-2"
>
    <button
      type="button"
      class={`${heroCtaMode === "booking"
  ? "openBookingBtn"
  : "openPrivateRequestBtn"}
  bg-yellow-400 hover:bg-yellow-300
  text-gray-900 font-extrabold
  text-sm md:text-base
  px-5 py-3 md:px-8 md:py-4
  rounded-xl
  w-full md:w-auto md:min-w-[300px]
  inline-flex items-center justify-center gap-2
  transition-all duration-300`}
      aria-expanded="false"
    >
      üóìÔ∏è {ui.verDisponibilidad}
    </button>
  </div>
</div>

<!-- Overlay -->
<div
  id="bookingOverlay"
  class="booking-overlay fixed inset-0 z-[70] hidden"
></div>

<!-- Booking Panel -->
<aside
  id="bookingPanel"
  class="booking-panel fixed left-0 right-0 bottom-0 z-[80]
         rounded-t-2xl shadow-2xl bg-white translate-y-full">
  <div class="panel-grabber w-12 h-1.5 bg-gray-300 rounded-full mx-auto mt-3 mb-2"></div>

  <div class="flex items-center justify-end px-4 py-3 border-b border-gray-200">
  <button
    type="button"
    class="closeBookingBtn p-2 rounded-lg hover:bg-gray-100 text-gray-600"
    aria-label="Cerrar">
    ‚úï
  </button>
  </div>

  <div class="panel-content overflow-y-auto max-h-[calc(100vh-8rem)] p-4">
  <BookingForm tour={tour} lang={lang} />
</div>

</aside>

<!-- CTA BEHAVIOUR: OCULTAR AL LLEGAR AL FOOTER -->
<script>
  if (typeof window !== "undefined") {
  document.addEventListener("DOMContentLoaded", () => {
    const cta = document.getElementById("bookingWidget");
    const footer = document.querySelector("footer");

    if (!cta || !footer) return;

    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          cta.classList.add("opacity-0", "pointer-events-none", "translate-y-6");
        } else {
          cta.classList.remove("opacity-0", "pointer-events-none", "translate-y-6");
        }
      },
      { threshold: 0.1 }
    );

    observer.observe(footer);
    
  });
  }
</script>


<!-- 9) FOOTER (global) -->
<Footer lang={lang} />


<!-- Integraciones (client) -->
{tour.elementosUnicos?.aiAssistant && (
<AIAssistant
  tourId={tour.slug}
  tourName={tour.titulo}
  lang={lang}
  ciudad={tour.ciudad}
  tipo={tipoTour}

/>

)}
{tour.elementosUnicos?.gamificacion && (
<GamificationSystem tourId={tour.slug} tourName={tour.titulo} client:load />
)}

<style>
/* ======================================================
   BOOKING OVERLAY
====================================================== */
.booking-overlay {
  position: fixed;
  inset: 0;
  z-index: 70;

  background: rgba(15, 23, 42, 0.45);
  backdrop-filter: blur(6px);

  opacity: 0;
  pointer-events: none;
  transition: opacity 280ms ease;
}

.booking-overlay.open {
  opacity: 1;
  pointer-events: auto;
}

/* ======================================================
   BOOKING PANEL ‚Äî MOBILE FIRST (BOTTOM SHEET)
====================================================== */
.booking-panel {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 80;

  height: 100vh;
  max-height: 100vh;

  background: #fff;
  border-radius: 24px 24px 0 0;
  box-shadow: var(--shadow-float);

  transform: translateY(100%);
  transition: transform 320ms cubic-bezier(0.2, 0.8, 0.2, 1);
}

.booking-panel.open {
  transform: translateY(0);
}

/* ======================================================
   PANEL CONTENT SCROLL (CR√çTICO)
====================================================== */
.booking-panel .panel-content {
  overflow-y: auto;
  max-height: calc(100vh - 4.5rem);
}

/* ======================================================
   DESKTOP ‚Äî MODAL CENTRADO (CERRADO POR DEFECTO)
====================================================== */
@media (min-width: 1024px) {
  .booking-panel {
    top: 50%;
    left: 50%;
    right: auto;
    bottom: auto;

    width: min(960px, 94vw);
    height: auto;
    max-height: 85vh;

    border-radius: 24px;

    transform: translate(-50%, calc(-50% + 120vh)); /* üîí oculto */
  }

  .booking-panel.open {
    transform: translate(-50%, -50%);
  }

  .booking-panel .panel-content {
    max-height: calc(85vh - 4.5rem);
  }
}

/* ======================================================
   BOUNCE (SOLO MOBILE)
====================================================== */
@keyframes iosBounceIn {
  0% { transform: translateY(100%); }
  80% { transform: translateY(-8px); }
  100% { transform: translateY(0); }
}

.booking-panel.bounce {
  animation: iosBounceIn 300ms cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* ======================================================
   BODY LOCK
====================================================== */
body.no-scroll {
  overflow: hidden;
  touch-action: none;
}

/* ======================================================
   MISC
====================================================== */
.panel-grabber {
  cursor: grab;
}
#bookingWidget {
  will-change: transform;
}
</style>

<script>
// Sticky widget show/hide
if (typeof window !== "undefined") {
  document.addEventListener("DOMContentLoaded", () => {
const widget = document.getElementById("bookingWidget");
if (!widget) return;

const showAt = 500;
const onScroll = () => {
if (window.scrollY > showAt) widget.classList.remove("translate-y-full");
else widget.classList.add("translate-y-full");
};
window.addEventListener("scroll", onScroll, { passive: true });
onScroll();
});

// Booking panel open/close
document.addEventListener("DOMContentLoaded", () => {
const overlay = document.getElementById("bookingOverlay") as HTMLElement | null;
const panel = document.getElementById("bookingPanel") as HTMLElement | null;
const openBtns = document.querySelectorAll(".openBookingBtn, .openPrivateRequestBtn");
const closeBtns = document.querySelectorAll(".closeBookingBtn");

if (!overlay || !panel || !openBtns.length) return;

let isOpen = false;

function openPanel() {
if (isOpen) return;
isOpen = true;

overlay!.classList.remove("hidden");
requestAnimationFrame(() => overlay!.classList.add("open"));

panel!.classList.add("open", "bounce");
document.body.classList.add("no-scroll");

openBtns.forEach((b) => b.setAttribute("aria-expanded", "true"));
setTimeout(() => panel!.classList.remove("bounce"), 320);
}

function closePanel() {
if (!isOpen) return;
isOpen = false;

overlay!.classList.remove("open");
panel!.classList.remove("open");
document.body.classList.remove("no-scroll");

openBtns.forEach((b) => b.setAttribute("aria-expanded", "false"));

setTimeout(() => {
if (!isOpen) overlay!.classList.add("hidden");
}, 300);
}

openBtns.forEach((btn) => {
btn.addEventListener("click", (e) => {
e.preventDefault();
openPanel();
});
});

closeBtns.forEach((btn) => btn.addEventListener("click", closePanel));
overlay.addEventListener("click", closePanel);

// Swipe-down close (mobile)
let startY = 0;
let currentY = 0;
let dragging = false;

const grabber = panel.querySelector(".panel-grabber");
const content = panel.querySelector(".panel-content");
if (!grabber || !content) return;

const startDrag = (clientY: number) => {
dragging = true;
startY = clientY;
currentY = 0;
panel.style.transition = "none";
};

const moveDrag = (clientY: number) => {
if (!dragging) return;
const delta = clientY - startY;
if (delta < 0) return;
currentY = Math.min(delta, window.innerHeight);
panel.style.transform = `translateY(${currentY}px)`;
overlay.style.opacity = String(Math.max(0, 1 - currentY / 300) * 0.35);
};

const endDrag = () => {
if (!dragging) return;
dragging = false;
panel.style.transition = "transform 300ms cubic-bezier(.2,.8,.2,1)";

if (currentY > 80) {
closePanel();
setTimeout(() => { panel.style.transform = ""; }, 310);
} else {
panel.classList.add("bounce");
panel.style.transform = "translateY(0)";
setTimeout(() => panel.classList.remove("bounce"), 320);
overlay.style.opacity = "";
}
};

grabber.addEventListener("touchstart", (e) => {
  const touch = (e as TouchEvent).touches[0];
  startDrag(touch.clientY);
}, { passive: true });
grabber.addEventListener("touchmove", (e) => {
  const touch = (e as TouchEvent).touches[0];
  moveDrag(touch.clientY);
  e.preventDefault();
}, { passive: false });
grabber.addEventListener("touchend", endDrag);

grabber.addEventListener("mousedown", (e) => {
  startDrag((e as MouseEvent).clientY);
});
window.addEventListener("mousemove", (e) => {
  moveDrag((e as MouseEvent).clientY);
});
window.addEventListener("mouseup", endDrag);
});
}
</script>
</Layout>
