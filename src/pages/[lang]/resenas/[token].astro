---
export const prerender = false;

const token = Astro.params.token;
const langParam = Astro.params.lang;

if (!token) {
  throw new Error("Missing token");
}

const API = import.meta.env.PUBLIC_STRAPI_URL;
if (!API) {
  throw new Error("PUBLIC_STRAPI_URL is not defined");
}

let data = null;

try {
  const res = await fetch(`${API}/reviews/start`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ token })
  });

  if (!res.ok) {
    return Astro.redirect(`/${langParam}/resenas/error?reason=invalid`);
  }

  data = await res.json();

} catch (err) {
  return Astro.redirect(`/${langParam}/resenas/error?reason=invalid`);
}

if (!data?.valid) {
  return Astro.redirect(`/${langParam}/resenas/error?reason=invalid`);
}

/*
  IMPORTANTE:
  usamos el locale real del token,
  no el que venga manipulado en la URL
*/
const safeLang = data.locale || langParam || "es";

return Astro.redirect(`/${safeLang}/resenas/formulario?token=${token}`);
---